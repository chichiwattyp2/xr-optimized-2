<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>XR Browser</title>     <!-- Google Fonts: Asimovian -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Keep only Asimovian loaded to guarantee it’s ready for canvases -->
    <link href="https://fonts.googleapis.com/css2?family=Asimovian&display=swap" rel="stylesheet">
<script src="js/openai-client.js"></script>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-controller-cursor-component@0.2.7/dist/aframe-controller-cursor-component.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
  <script src="https://unpkg.com/aframe-environment-component@1.5.x/dist/aframe-environment-component.min.js"></script>
  <script src="https://unpkg.com/aframe-event-set-component@5.0.1/dist/aframe-event-set-component.min.js"></script>
  <script src="js/assistant.js" defer></script>
  <script src="js/travel-node-component.js"></script>
  <script src="js/nav.js"></script>

  <script>
  function encodeHtml(str) {
    const buf = [];
    for (let i = str.length - 1; i >= 0; i--) buf.unshift(["&#", str[i].charCodeAt(), ";"].join(""));
    return buf.join("");
  }
  const isImageUrl = (u) => /\.(png|jpe?g|gif|webp)(\?.*)?$/i.test(u);

  $(function () {
    const SHEET_ID = "1fy-ZztZlhwgfz1wH8YGji2zuiiEfV88XyCRBDzLB1AA";
    const GID = 9;
    const gvizUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}`;

    $.get(gvizUrl, function (text) {
      const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf(")")));
      const rows = json.table.rows || [];
      const listings = [];

      for (let r = 1; r < rows.length; r++) {
        const cells = rows[r].c || [];
        const title = cells[0]?.v ?? "";
        const image = String(cells[1]?.v ?? "");
        const link  = String(cells[2]?.v ?? "");

        if ((title || image || link) && isImageUrl(image)) {
          listings.push({
            title: encodeHtml(String(title)),
            image,
            link
          });
        }
      }

      let r = 0, i = 0, p = 0, h = 0, pages = 0;
      for (const listing of listings) {
        const x = i * 2;       // cleaner numeric position
        const y = r * 1.3;
        $("#container").append(`
          <a-image crossorigin="anonymous" position="${x} ${y} 0"
                   width="2" height="1"
                   link="href: ${listing.link}"
                   src="${listing.image}"
                   event-set__enter="_event: mouseenter; _target: #highlight-${h}; visible: true"
                   event-set__leave="_event: mouseleave; _target: #highlight-${h}; visible: false">
            <a-entity geometry="primitive: plane; width: 2; height: .2"
                      material="color: #111"
                      text="align:center; value: ${listing.title}"
                      position="0 -.6 0"></a-entity>
            <a-plane id="highlight-${h}" width="2.05" height="1.25"
                     material="shader: flat; color: white;"
                     position="0 -0.1 -0.01" visible="false"></a-plane>
          </a-image>
        `);

        i++; h++;
        if (i === 4) { r--; i = 0; p++; }
        if (p === 3) { r += 20; p = 0; pages++; console.log(pages); }
      }
    });
  });
  </script> 
</head>
<body>



  <a-scene antialias="true" vr-mode-ui="enabled: true" loading-screen="backgroundColor: #212121" physics>
  
    
 


          
      
  <a-entity id="rig" movement-controls="controls: checkpoint" checkpoint-controls="mode: animate" position="0 2.22085 6.6555" rotation="0 0 0">
          <a-camera>
         <a-entity cursor="" position="0.00705 0.04225 -1.70324" geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03" material="shader: flat; color: #ff3300" raycaster=""></a-entity></a-camera></a-entity>
   

<a-assets>  
    <a-asset-item id="assistant-gltf" src="/assets/character.glb"></a-asset-item>
    </a-assets>

    <a-entity environment="dressing: none; ground: flat; fog: 0; skyType: none; groundColor: #111; gridColor: #202020; grid: 2x2; groundTexture: none"></a-entity>
<!-- ai -->
  <a-entity id="ai">
  <a-entity id="virtual-assistant"
              class="clickable"
              gltf-model="#assistant-gltf"
              animation-mixer="crossFadeDuration: 0.4"
              position="0 0 -3"
              scale="1 1 1"
              rotation="0 0 0"
              speech-input
              speech-output
              ai-brain="endpoint: api/vr-assistant.js"></a-entity>

    <!-- Status text (put color on text, not material) -->
    <a-entity position="0 2.5 -2"
              text="value: Press SPACE or click assistant to talk!; color: #FFF; align: center"
              id="status-text"></a-entity></a-entity>
    
    
    
    <a-entity id="catalog" scale=".2 .2 .2" position="0 1.1 -1.05">
      <a-entity class="container" id="container" position="-3.15 4 0"></a-entity>
      <a-entity id="arrows" position="0 .3 .2">
        <a-image id="mainLogo"
                 src="https://cdn.glitch.com/a0f896a4-4e28-47a9-b792-0307f9c0c167%2Fchris-menu.png"
                 position="0 5.8 0" width="4" height="2"></a-image>
      </a-entity>

      <a-entity id="menu" position="-3.06 4.98 0" scale=".35 .35 .35">
        <!-- menu items unchanged -->
      </a-entity>
    </a-entity>

    <!--<a-image id="how-to"
             src="https://cdn.glitch.com/22ec690f-3d8c-49a9-b10a-903a96c741e5%2Fpng.png"
             position="-1.26232 1.6 0.02932"
             width="0.47" height="0.3"
             rotation="0 90 0" scale="3 3 3"></a-image>

    <a-entity geometry="primitive: plane; height: 10; width: 18"
              material="opacity: 0;"
              typer="message: Click on a item to get in touch.\n\n; on: click;"
              text="value: Looking forward to hearing from you.; font: roboto; align: center; color: white; width: 2.8; zOffset: 0.01; letterSpacing: -1; tabSize: 1; side: double;"
              position="0 1.4 -2" rotation="-15 0 0"></a-entity> -->
  </a-scene>

</body>
</html>

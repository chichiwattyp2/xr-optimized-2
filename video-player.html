<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Aurora VR Video Player</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@4.2.1/dist/aframe-event-set-component.min.js"></script>
    <link rel="stylesheet" href="css/webvr.css" type="text/css" />
  </head>
  <body>
    <div id="startscreen" class="welcome">
      <div class="wlcnt">
        <img alt="Aurora Playerâ„¢" height="122" width="119" src="assets/Christopher.gif">
        <h1 class="hidden">Video Player for VR</h1>
        <p>Play your own videos with atmospheric lighting effects that match the content of the video. And that in this virtual reality room.</p>
        <button id="btnstart">Start Now the Experience</button>
      </div>
    </div>

    <button id="video-permission-button" style="display:none;">Allow VR video</button>
    <input id="file" type="file" accept="video/*" style="display:none;" />

    <a-scene id="mainscene" fog="type: linear; near:20; far:50; color: #111111;" cursor="rayOrigin: mouse">
      <a-assets>
        <img src="assets/play-light.png" id="play" crossorigin="anonymous" />
        <img src="assets/pause.png" id="pause" crossorigin="anonymous" />
        <img src="assets/volume-normal.png" id="volume-normal" crossorigin="anonymous" />
        <img src="assets/volume-mute.png" id="volume-mute" crossorigin="anonymous" />
        <img src="assets/seek-back.png" id="seek-back" crossorigin="anonymous" />
        <img src="assets/open-light.png" id="open-light" crossorigin="anonymous" />
        <img src="assets/settings-light.png" id="open-settings" crossorigin="anonymous" />
        <img src="assets/white_grid_thin.png" id="grid" crossorigin="anonymous" />
        <video id="video-src" src="assets/csg.m4v" playsinline webkit-playsinline crossorigin="anonymous"></video>
      </a-assets>
      <a-entity position="0 1.8 0">
        <a-entity camera look-controls mouse-cursor>
          <a-cursor
            fuse="true"
            timeout="500"
            color="#F0F0F0"
            scale="0.6 0.6 0.6"
          ></a-cursor>
        </a-entity>
      </a-entity>

      <a-plane id="flatborder" material="color:black" rotation="0 0 0" height="100" width="100" position="0 5.5 -16.1"></a-plane>
      <a-sound id="alert-sound" src="src: url(assets/action.wav)" autoplay="false" position="0 0 0"></a-sound>
      <a-video id="video-screen" src="#video-src" position="0 5.5 -16" width="16" height="9"></a-video>

      <a-image id="control-open" width="0.4" height="0.4" src="#open-light" position="-1.6 0.6 -6"></a-image>
      <a-image id="control-back" width="0.4" height="0.4" src="#seek-back" position="-0.8 0.6 -6" visible="false" scale="0.85 0.85 0.85"></a-image>
      <a-image id="control-play" width="0.4" height="0.4" src="#play" position="0 0.6 -6"></a-image>
      <a-image id="control-volume" width="0.4" height="0.4" src="#volume-normal" position="0.8 0.6 -6" visible="false" scale="0.75 0.75 0.75"></a-image>
      <a-image id="control-settings" width="0.4" height="0.4" src="#open-settings" position="1.6 0.6 -6" scale="0.75 0.75 0.75"></a-image>

      <!-- The rest of your controls, progress bar, settings-panel, sky, light, etc. remain unchanged for brevity -->

      <a-entity geometry="primitive: plane; width: 10000; height: 10000;" rotation="-90 270 0" material="src: #grid; repeat: 10000 10000; transparent: true; opacity:0.2;"></a-entity>
      <a-sky color="#dbdedb"></a-sky>
      <a-entity light="color: #FFF; intensity: 1; type: ambient;"></a-entity>

      <!-- ... Your light grid entities (right, top, left, bottom) ... -->
    </a-scene>

    <!-- Custom JS (place at end of body to ensure DOM is ready) -->
    <script>
      // Helper: wait for A-Frame scene to fully load
      window.addEventListener('DOMContentLoaded', function() {
        // Hide welcome screen
        document.getElementById("btnstart").addEventListener("click", function() {
          document.getElementById("startscreen").style.display = "none";
        });

        // Get video element and player controls
        var video = document.getElementById("video-src");
        var videoScreen = document.querySelector("#video-screen");
        var playBtn = document.querySelector("#control-play");
        var openBtn = document.querySelector("#control-open");
        var fileInput = document.getElementById("file");
        var cursor = document.querySelector("a-cursor");

        // Cursor scale animations
        let hideCursor = function() {
          if (!cursor) return;
          cursor.removeAttribute("animation__cursorHideLeave");
          cursor.setAttribute(
            "animation__cursorHideEnter",
            "property: scale; from: 0.6 0.6 0.6; to: 0 0 0; dur: 300; easing: easeInQuad;"
          );
        };
        let showCursor = function() {
          if (!cursor) return;
          cursor.removeAttribute("animation__cursorHideEnter");
          cursor.setAttribute(
            "animation__cursorHideLeave",
            "property: scale; from: 0 0 0; to: 0.6 0.6 0.6; dur: 300; easing: easeInQuad;"
          );
        };

        // Video hover events
        if(videoScreen){
          videoScreen.addEventListener("mouseenter", showCursor);
          videoScreen.addEventListener("mouseleave", hideCursor);
        }

        // Play/Pause toggle (updates icon if desired)
        playBtn.addEventListener("click", function() {
          if (video.paused) {
            video.play();
            playBtn.setAttribute('src', '#pause');
          } else {
            video.pause();
            playBtn.setAttribute('src', '#play');
          }
        });

        // Open file browser on "open" button click
        openBtn.addEventListener("click", function() {
          fileInput.click();
        });

        // Handle file input
        fileInput.addEventListener("change", function(evt) {
          evt.preventDefault();
          var file = evt.target.files[0];
          if (!file || file.type.split("/")[0] !== "video") {
            window.alert("Please select a file with a `video/*` mime-type");
            return false;
          }
          var url = window.URL.createObjectURL(file);
          video.src = url;
          // Play video after file loads
          video.onloadeddata = function() {
            video.play();
            playBtn.setAttribute('src', '#pause');
            hideCursor();
          };
          video.onerror = function(err) {
            window.alert("Sorry! But something went wrong here :(");
            playBtn.setAttribute('src', '#play');
          };
        });

        // Optionally, auto-hide play button when playing (customize as needed)
        video.addEventListener('play', function() {
          playBtn.setAttribute('src', '#pause');
        });
        video.addEventListener('pause', function() {
          playBtn.setAttribute('src', '#play');
        });

        // Prevent links from opening in Safari PWA (iOS)
        if ("standalone" in window.navigator && window.navigator.standalone) {
          document.addEventListener("click", function(event) {
            var target = event.target;
            while (target && target.nodeName !== "A" && target.nodeName !== "HTML") {
              target = target.parentNode;
            }
            if (
              target &&
              target.nodeName === "A" &&
              (target.href.indexOf("http") || ~target.href.indexOf(location.host))
            ) {
              event.preventDefault();
              location.href = target.href;
            }
          }, false);
        }
      });
    </script>
  </body>
</html>
